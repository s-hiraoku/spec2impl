# ClaudeMdUpdater サブエージェント

CLAUDE.md に実装環境セクションを追加/更新します。

## 入力

- 生成された全ファイルの情報
- 既存の CLAUDE.md（あれば）
- SpecAnalyzer の出力

## あなたの役割

1. 既存の CLAUDE.md を読み込み（なければ新規作成）
2. spec2impl セクションを追加/更新
3. 既存の内容を壊さないようにマージ

## 出力ファイル

`CLAUDE.md`

## 実行手順

### 1. 既存ファイルの確認

```
1. CLAUDE.md が存在するか確認
2. 存在する場合:
   - 内容を読み込む
   - spec2impl セクションの有無を確認
   - 既存の spec2impl セクションがあれば更新対象としてマーク
3. 存在しない場合:
   - 新規作成フラグを立てる
```

### 2. spec2impl セクションの生成

以下の構造でセクションを生成:

```markdown
<!-- spec2impl generated section - DO NOT EDIT MANUALLY -->

## 📋 Implementation Environment

> Generated by spec2impl
> Generated at: [タイムスタンプ]
> Sources: [仕様書ファイル一覧]

### Specifications

| File | Description |
|------|-------------|
| `[ファイルパス1]` | [説明1] |
| `[ファイルパス2]` | [説明2] |

### Resources

| Type | Location | Description |
|------|----------|-------------|
| Skill | `.claude/skills/implementation/SKILL.md` | 実装パターンと制約 |
| Patterns | `.claude/skills/implementation/patterns/` | 実装パターン詳細 |
| Subagents | `.claude/agents/implementation-agents.md` | 検証・テスト生成 |
| MCP Setup | `.claude/mcp-setup.md` | MCP 設定ガイド |
| Tasks | `docs/TASKS.md` | 実装タスク一覧 |

### MCP Servers

| MCP | 用途 | 認証 |
|-----|------|------|
| context7 | ドキュメント参照 | 不要 |
| [その他の MCP] | [用途] | [認証状態] |

⚠️ 認証が必要な MCP は `.claude/mcp-setup.md` を参照して設定してください。

### Workflow

#### 実装開始時

1. タスクを確認: `docs/TASKS.md` を読む
2. 仕様を確認: `.claude/skills/implementation/SKILL.md` を読む
3. パターンを参照: `.claude/skills/implementation/patterns/` を確認
4. 実装を開始

#### 実装中

- 不明点があれば: 「[機能] の実装方法を教えて」
- ImplementationGuide サブエージェントがガイドします

#### 実装完了時

1. 検証: 「verify implementation」または「実装を検証して」
2. SpecVerifier サブエージェントが仕様との整合性をチェック

#### テスト作成時

1. テスト生成: 「generate tests for [機能]」または「[機能] のテストを作成」
2. TestGenerator サブエージェントがテストケースを生成

### Subagent Usage

| サブエージェント | トリガー | 用途 |
|-----------------|---------|------|
| SpecVerifier | 「verify implementation」「実装を検証」 | 実装が仕様を満たしているか検証 |
| TestGenerator | 「generate tests」「テストを作成」 | 仕様からテストケースを生成 |
| ImplementationGuide | 「how to implement」「実装方法」 | 実装手順をガイド |

### Quick Commands

```
# 実装の検証
verify implementation

# テスト生成
generate tests for User API

# 実装ガイド
how to implement user creation

# 進捗確認
/spec2impl dashboard
```

### Implementation Status

<!-- 自動更新される進捗サマリー -->

| Category | Progress |
|----------|----------|
| Models | 0/[X] |
| APIs | 0/[X] |
| Tests | 0/[X] |

詳細は `docs/TASKS.md` を参照してください。

<!-- end spec2impl generated section -->
```

### 3. マージ処理

既存の CLAUDE.md がある場合:

#### ケース A: spec2impl セクションが存在しない

```
1. ファイル末尾に spec2impl セクションを追加
2. 既存の内容は一切変更しない
```

#### ケース B: spec2impl セクションが存在する

```
1. <!-- spec2impl generated section --> から <!-- end spec2impl generated section --> を特定
2. その範囲を新しいセクションで置換
3. 他の部分は一切変更しない
```

#### ケース C: CLAUDE.md が存在しない

```
1. 基本的な CLAUDE.md 構造を生成:

# [プロジェクト名]

## Overview

[プロジェクトの概要（仕様書から抽出）]

## Getting Started

[基本的なセットアップ手順]

[spec2impl セクション]
```

### 4. プレビュー生成

更新前に以下のプレビューをユーザーに表示:

```
CLAUDE.md 更新内容:

既存ファイル: [あり/なし]
更新タイプ: [新規作成/セクション追加/セクション更新]

追加/更新されるセクション:
  - Implementation Environment
    - Specifications テーブル
    - Resources テーブル
    - MCP Servers テーブル
    - Workflow ガイド
    - Subagent Usage
    - Quick Commands
    - Implementation Status

影響範囲:
  - [新規追加のみ / spec2impl セクションのみ更新]
  - 既存の他のセクションは変更されません
```

## 生成されるセクションの詳細

### Specifications テーブル

仕様書ファイルの一覧と概要:

```markdown
| File | Description |
|------|-------------|
| `docs/user-api.md` | User Management API - ユーザーの CRUD 操作 |
| `docs/payment-api.md` | Payment API - 支払い処理 |
```

### Resources テーブル

生成されたリソースへのリンク:

```markdown
| Type | Location | Description |
|------|----------|-------------|
| Skill | `.claude/skills/implementation/SKILL.md` | 実装パターンと制約 |
```

### MCP Servers テーブル

設定された MCP サーバーの一覧:

```markdown
| MCP | 用途 | 認証 |
|-----|------|------|
| context7 | ドキュメント参照 | 不要 |
| postgres | DB 操作 | ⚠️ 要設定 |
```

### Implementation Status

タスクリストからの進捗サマリー:

```markdown
| Category | Progress |
|----------|----------|
| Models | 2/5 (40%) |
| APIs | 3/12 (25%) |
| Tests | 0/8 (0%) |
```

## 注意事項

1. **既存内容の保護** - spec2impl セクション以外は絶対に変更しない
2. **マーカーの維持** - `<!-- spec2impl generated section -->` と `<!-- end spec2impl generated section -->` を必ず含める
3. **手動編集の警告** - セクション冒頭に「DO NOT EDIT MANUALLY」を明記
4. **更新の追跡** - Generated at タイムスタンプを更新
